<!DOCTYPE html>
<html>
<body>
<template id="svg-template">
<svg xmlns="http://www.w3.org/2000/svg">
<foreignObject width="100%" height="100%">
<div xmlns="http://www.w3.org/1999/xhtml">
</div>
</foreignObject>
</svg>
</template>
<script type="module">
const outCanvas = document.getElementById("out-canvas")
const ctx = outCanvas.getContext("2d");
const width = outCanvas.width;
const height = outCanvas.height;

const svgTemplate = document.getElementById("svg-template").content;
const xmlSerializer = new XMLSerializer();

function dataURL(contentType, body) {
    return `data:${contentType},${encodeURIComponent(body)}`;
}

// await render("<h1>hello world</h1>")
async function render(html) {
    const svgdoc = svgTemplate.cloneNode(true);
    svgdoc.width = width;
    svgdoc.height = height;
    svgdoc.querySelector("div").innerHTML = html;

    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");

    const img = document.createElement("img");
    const imageLoad = new Promise((resolve, reject) => {
      img.addEventListener("load", resolve);
    });
    img.src = dataURL("image/svg+xml", xmlSerializer.serializeToString(svgdoc));
    //document.body.appendChild(img);
    await imageLoad;

    ctx.drawImage(img, 0, 0);
    return ctx.getImageData(0, 0, width, height).data;
}

/*
function minus(a, b) {
    //return ((a + 256 - b) % 256) | 0;
    return (Math.max(a, b) - Math.min(a, b)) | 0;
}

function normalize(r, g, b, a) {
    if (a == 255) {
        return [r, g, b];
    } else if (a == 0) {
        return [255, 255, 255];
    } else {
        var f = a / 256;
        var c = 255 - a;
        return [(r * f) | 0 + c, (g * f) | 0 + c, (b * f) | 0 + c];
    }
}
   var [ar, ag, ab] = normalize(...world.slice(o, o + 4));
   var [br, bg, bb] = normalize(...womp.slice(o, o + 4));
   diffedArray.set([minus(ar, br), minus(ag, bg), minus(ab, bb), 255], o);
   diffedArray[offset + 0] = minus(world[offset + 0], womp[offset + 0]);
   diffedArray[offset + 1] = minus(world[offset + 1], womp[offset + 1]);
   diffedArray[offset + 2] = minus(world[offset + 2], womp[offset + 2]);
   //diffedArray[offset + 3] = minus(world[offset + 3], womp[offset + 3]);
   diffedArray[offset + 3] = Math.max(world[offset + 3], womp[offset + 3]);
*/

function renderDiff(older, newer) {
    const diffedArray = new Uint8ClampedArray(width * height * 4);
    let isDifferent = false;

    for (var i = 0; i < width * height * 4; i += 4) {
        var a = older.slice(i, i + 4);
        var b = newer.slice(i, i + 4);
        if (a[0] != b[0] || a[1] != b[1] || a[2] != b[2] || a[3] != b[3]) {
            diffedArray[i + 3] = 255;
            isDifferent = true;
        }
    }
    return new ImageData(diffedArray, width, height);
}

Object.assign(window, {render, renderDiff});

const older = await render(await (await fetch("../blog-output/blog/per-computer-colored-prompts-in-bash")).text());
const newer = await render("hi<p><h1>hello <font color=#000001>womp</font> womp</h1>");
//ctx.putImageData(new ImageData(older, width, height), 0, 0);

ctx.putImageData(renderDiff(older, newer), 0, 0);

/*

document.querySelector("img").addEventListener("dragover", e => {e.preventDefault();});
undefined
let p = Promise.withResolvers();
undefined
document.querySelector("img").addEventListener("drop", e => {e.preventDefault(); p.resolve(e.dataTransfer.items);}); 

let e = f[0].webkitGetAsEntry();
e.createReader().readEntries(console.log) 
*/

</script>
<canvas width="1024" height="512" id="out-canvas"></canvas>
</body>
</html>
